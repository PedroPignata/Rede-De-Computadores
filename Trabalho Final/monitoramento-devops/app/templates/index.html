<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Monitoramento DevOps</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS High Contrast Dark Mode */
        body { background-color: #000000; color: #ffffff; font-family: 'Segoe UI', sans-serif; padding: 30px; margin: 0; }
        
        h2 { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 1px; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }

        .card {
            background-color: #0f0f0f;
            border: 1px solid #222;
            border-top: 5px solid #444; /* Default Color */
            border-radius: 8px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 220px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
            transition: transform 0.2s ease, border-color 0.3s ease;
        }

        .card:hover { transform: translateY(-5px); }

        /* Cores de Status (Requisito 4) */
        .status-NORMAL { border-top-color: #00ff41; box-shadow: 0 0 10px rgba(0, 255, 65, 0.1); }
        .status-NORMAL .val, .status-NORMAL h3 { color: #00ff41; }

        .status-ATENCAO { border-top-color: #ffcc00; box-shadow: 0 0 10px rgba(255, 204, 0, 0.1); }
        .status-ATENCAO .val, .status-ATENCAO h3 { color: #ffcc00; }

        .status-CRITICO { border-top-color: #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.2); }
        .status-CRITICO .val, .status-CRITICO h3 { color: #ff0000; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Textos */
        h3 { margin: 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .val { font-size: 3.5rem; font-weight: 700; margin: 20px 0; text-align: center; }
        .unit { font-size: 1rem; color: #666; font-weight: normal; }
        
        .extra-metrics { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 10px; background: #1a1a1a; padding: 5px; border-radius: 4px;}

        .footer { 
            text-align: center; font-size: 0.95rem; color: #ccc; 
            border-top: 1px solid #222; padding-top: 15px; margin-top: auto; 
        }

    </style>
</head>
<body>

    <h2><i class="fa-solid fa-network-wired"></i> Monitoramento de Serviços DevOps</h2>

    <div class="dashboard-grid">

        <div id="card-web" class="card status-NORMAL">
            <h3><i class="fa-solid fa-globe"></i> WEB SERVER (NGINX) <span id="badge-web">ONLINE</span></h3>
            <div class="val"><span id="val-web">--</span><span class="unit">ms</span></div>
            <div class="extra-metrics">RPS: <span id="rps-web">120</span> | Erros: 0.1%</div>
            <div class="footer" id="msg-web">Inicializando...</div>
        </div>

        <div id="card-db" class="card status-NORMAL">
            <h3><i class="fa-solid fa-database"></i> BANCO DE DADOS <span id="badge-db">ONLINE</span></h3>
            <div class="val"><span id="val-db">--</span><span class="unit">ms</span></div>
            <div class="extra-metrics">QPS: <span id="qps-db">340</span> | Conn: 45</div>
            <div class="footer" id="msg-db">Inicializando...</div>
        </div>

        <div id="card-smtp" class="card status-NORMAL">
            <h3><i class="fa-regular fa-envelope"></i> SMTP SERVER <span id="badge-smtp">ONLINE</span></h3>
            <div class="val" id="val-smtp" style="font-size: 2.5rem;">OK</div>
            <div class="extra-metrics">Fila de Saída: <span id="queue-smtp">0</span></div>
            <div class="footer" id="msg-smtp">Inicializando...</div>
        </div>

        <div id="card-sec" class="card status-NORMAL">
            <h3><i class="fa-solid fa-shield-halved"></i> SEGURANÇA <span id="badge-sec">OK</span></h3>
            <div class="val" id="val-sec" style="font-size: 2.5rem;">PROTEGIDO</div>
            <div class="extra-metrics">Integridade de Arquivos</div>
            <div class="footer" id="msg-sec">Monitorando protegido.conf</div>
        </div>

    </div>

    <script>
        // Armazena o último estado para evitar flood de e-mails
        const lastStates = { web: 'NORMAL', db: 'NORMAL', smtp: 'NORMAL', sec: 'NORMAL' };

        async function updateDashboard() {
            try {
                // Busca dados do Python
                const res = await fetch('/api/status');
                const data = await res.json();

                // Atualiza Cards com dados reais + simulação visual de metricas extras
                renderCard('web', data.web.ping, data.web.status_text, data.web.level, "Web Server Nginx");
                renderCard('db', data.db.ping, data.db.status_text, data.db.level, "Banco de Dados SQL");
                renderCard('smtp', data.smtp.ping, data.smtp.status_text, data.smtp.level, "Servidor SMTP");
                
                // Card de Segurança (Lógica separada)
                renderSecCard(data.sec.status_text, data.sec.level);

            } catch (error) {
                console.error("Erro de conexão com API:", error);
            }
        }

        function renderCard(id, ping, statusText, level, niceName) {
            const card = document.getElementById(`card-${id}`);
            const val = document.getElementById(`val-${id}`);
            const msg = document.getElementById(`msg-${id}`);
            const badge = document.getElementById(`badge-${id}`);

            // Atualiza Classes Visuais
            card.className = `card status-${level}`;

            // Lógica de Texto e Métricas Visuais
            if (statusText === 'OFFLINE') {
                val.innerText = "OFF";
                msg.innerText = "SERVIÇO INDISPONÍVEL";
                badge.innerText = "DOWN";
            } else {
                val.innerText = ping;
                badge.innerText = "ONLINE";
                
                if (level === 'ATENCAO') {
                    msg.innerText = "Latência Alta / Degradação";
                } else {
                    msg.innerText = "Operacional";
                }
            }

            // Simulação visual de números "vivos" (RPS, QPS) para ficar bonito
            if(id === 'web') document.getElementById('rps-web').innerText = 100 + Math.floor(Math.random() * 50);
            if(id === 'db') document.getElementById('qps-db').innerText = 300 + Math.floor(Math.random() * 80);
            
            // VERIFICA SE PRECISA MANDAR EMAIL (Requisito 4: Amarelo e Vermelho)
            checkAndTriggerEmail(id, level, niceName, msg.innerText);
        }

        function renderSecCard(text, level) {
            const card = document.getElementById('card-sec');
            const val = document.getElementById('val-sec');
            const msg = document.getElementById('msg-sec');
            const badge = document.getElementById('badge-sec');

            card.className = `card status-${level}`;
            val.innerText = (level === 'CRITICO') ? "ALERTA" : "PROTEGIDO";
            badge.innerText = (level === 'CRITICO') ? "CRÍTICO" : "OK";
            
            if (level === 'CRITICO') {
                msg.innerText = "Alteração detectada em arquivos!";
            } else {
                msg.innerText = "Nenhuma alteração detectada.";
            }
            // O backend já envia email de segurança sozinho via watcher de arquivo
        }

        function checkAndTriggerEmail(id, currentLevel, name, details) {
            // Se o estado mudou (ex: era NORMAL e virou ATENCAO)
            if (currentLevel !== lastStates[id]) {
                
                // Requisito 4: Enviar e-mail para Nível 2 (Amarelo) e Nível 3 (Vermelho)
                if (currentLevel === 'ATENCAO' || currentLevel === 'CRITICO') {
                    
                    console.log(`Disparando email para ${name} - Status: ${currentLevel}`);
                    
                    fetch('/api/trigger-email', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            servico: name, 
                            status: currentLevel === 'ATENCAO' ? 'ATENÇÃO (Degradação)' : 'CRÍTICO (Indisponível)', 
                            msg: details 
                        })
                    });
                }
                
                // Atualiza memória
                lastStates[id] = currentLevel;
            }
        }

        // Atualiza a cada 3 segundos
        setInterval(updateDashboard, 3000);
        updateDashboard();
    </script>
</body>
</html>